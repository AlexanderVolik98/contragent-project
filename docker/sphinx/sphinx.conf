source company_src
{
    type            = pgsql
    sql_host        = postgres
    sql_port        = 5432
    sql_user        = app
    sql_pass        = password
    sql_db          = app

    sql_query = \
      SELECT c.id, c.name, c.inn, c.ogrn, c.kpp, c.phones, c.emails, c.slug, \
             cc.value AS capital_value, \
             'Company' AS entity_type, \
             ss.status AS state_status, \
             TO_CHAR(ss.registration_date, 'YYYYMMDD')::BIGINT AS registration_date_int, \
             r.name AS region_name, \
             opf.abbreviation as opf_abbreviation, \
             o.name AS okved_name, \
             CASE ss.status \
               WHEN 'ACTIVE' THEN 1 \
               WHEN 'REORGANIZING' THEN 2 \
               WHEN 'LIQUIDATING' THEN 3 \
               WHEN 'LIQUIDATED' THEN 4 \
               WHEN 'BANKRUPT' THEN 5 \
               ELSE 6 \
             END AS state_status_order \
      FROM company c \
      LEFT JOIN company_capital cc ON cc.company_id = c.id \
      LEFT JOIN subject_state ss ON ss.company_id = c.id \
      LEFT JOIN subject_address sa ON sa.company_id = c.id \
      LEFT JOIN opf ON opf.id = c.opf_id \
      LEFT JOIN region r ON r.id = sa.region_id \
      LEFT JOIN subject_okved sok ON sok.company_id = c.id AND sok.is_primary = true \
      LEFT JOIN okved o ON o.code = sok.okved_id


}

index company_idx
{
    source          = company_src
    path            = /var/lib/sphinx/company_idx
    morphology      = stem_ru,stem_en
    min_word_len    = 3

    field_string = name
    field_string = inn
    field_string = ogrn
    field_string = kpp
    field_string = okved_name

    attr_string     = region_name
    attr_string     = slug
    attr_string     = phones
    attr_string     = emails
    attr_string     = opf_abbreviation
    attr_string     = state_status
    attr_string     = entity_type
    attr_bigint     = capital_value
    attr_uint       = state_status_order
    attr_bigint     = registration_date_int

    charset_table   = 0..9, A..Z->a..z, _, a..z, U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+0435, U+451->U+0435
    min_prefix_len  = 3
    html_strip      = 1
    expand_keywords = 1
}

source individual_src
{
    type            = pgsql
    sql_host        = postgres
    sql_port        = 5432
    sql_user        = app
    sql_pass        = password
    sql_db          = app

    sql_query = \
      SELECT i.id, \
             (i.surname || ' ' || i.name || COALESCE(' '||i.patronymic, '')) AS name, \
             i.inn, \
             i.ogrnip, \
             i.phones, \
             'Individual' AS entity_type, \
             i.emails, \
             CASE ss.status \
               WHEN 'ACTIVE' THEN 1 \
               WHEN 'LIQUIDATED' THEN 2 \
               ELSE 3 \
             END AS state_status_order, \
             i.slug, \
             ss.status AS state_status, \
             TO_CHAR(ss.registration_date, 'YYYYMMDD')::BIGINT AS registration_date_int, \
             r.name AS region_name, \
             '' AS ogrn, \
             '' AS kpp, \
             '' AS opf_abbreviation, \
             o.name AS okved_name \
      FROM individual i \
      LEFT JOIN subject_state ss ON ss.individual_id = i.id \
      LEFT JOIN subject_address sa ON sa.individual_id = i.id \
      LEFT JOIN region r ON r.id = sa.region_id \
      LEFT JOIN subject_okved sok ON sok.individual_id = i.id AND sok.is_primary = true \
      LEFT JOIN okved o ON o.code = sok.okved_id


}

index individual_idx
{
    source          = individual_src
    path            = /var/lib/sphinx/individual_idx
    morphology      = stem_ru,stem_en
    min_word_len    = 3

    field_string = name
    field_string = inn
    field_string = ogrnip
    field_string = okved_name

    attr_string     = region_name
    attr_string     = slug
    attr_string     = phones
    attr_string     = emails
    attr_uint       = state_status_order
    attr_string     = state_status
    attr_string     = entity_type
    attr_bigint     = registration_date_int
    attr_string     = ogrn
    attr_string     = kpp
    attr_string     = opf_abbreviation

    charset_table   = 0..9, A..Z->a..z, _, a..z, U+410..U+42F->U+430..U+44F, \
                      U+430..U+44F, U+401->U+0435, U+451->U+0435
    min_prefix_len  = 3
    html_strip      = 1
    expand_keywords = 1
}

index all_entities
{
    type    = distributed
    local   = company_idx
    local   = individual_idx
}

searchd
{
    listen           = 0.0.0.0:9306:mysql41
    listen           = 9315
    log              = /var/lib/sphinx/logs/searchd.log
    query_log        = /var/lib/sphinx/logs/query.log
    binlog_path      = /var/lib/sphinx/binlog
    pid_file         = /var/lib/sphinx/logs/searchd.pid

    read_timeout     = 5
    max_children     = 30
    seamless_rotate  = 1
    preopen_indexes  = 1
    unlink_old       = 1
    workers          = threads
}
